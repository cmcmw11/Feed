<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Feed - ‡πÇ‡∏•‡∏Å‡∏™‡∏ß‡∏¢ Social</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap');
body { font-family:'Quicksand',sans-serif; background:#f0f2f5; margin:0; padding:20px; display:flex; justify-content:center; }
.container { width:400px; }
input, select { width:100%; padding:10px; margin:5px 0; border-radius:10px; border:1px solid #ddd; font-size:14px; }
.card { background:#fff; border-radius:15px; padding:15px; margin-bottom:15px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
.card p { margin:5px 0; }
.card .actions { display:flex; justify-content:space-between; margin-top:10px; }
button { border:none; border-radius:10px; padding:5px 10px; cursor:pointer; }
button:hover { opacity:0.8; }
.category-filter { display:flex; justify-content:space-around; margin-bottom:10px; }
.category-filter button { padding:5px 10px; background:#ffefef; cursor:pointer; border-radius:10px; font-size:12px; }
</style>
</head>
<body>
<div class="container">
  <input type="text" id="searchUser" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô @username...">
  <div class="category-filter">
    <button onclick="filterCategory('‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button onclick="filterCategory('‡πÇ‡∏•‡∏Å‡∏™‡∏ß‡∏¢')">‡πÇ‡∏•‡∏Å‡∏™‡∏ß‡∏¢</button>
    <button onclick="filterCategory('‡πÅ‡∏£‡∏á‡∏ö‡∏±‡∏ô‡∏î‡∏≤‡∏•‡πÉ‡∏à')">‡πÅ‡∏£‡∏á‡∏ö‡∏±‡∏ô‡∏î‡∏≤‡∏•‡πÉ‡∏à</button>
    <button onclick="filterCategory('‡∏Ç‡∏≥‡∏Ç‡∏±‡∏ô')">‡∏Ç‡∏≥‡∏Ç‡∏±‡∏ô</button>
  </div>
  <div id="posts"></div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCXcq9coy4Ah39DTzN9OmZc-nm8JBHPapA",
  authDomain: "feed-32f94.firebaseapp.com",
  projectId: "feed-32f94",
  storageBucket: "feed-32f94.appspot.com",
  messagingSenderId: "939495314483",
  appId: "1:939495314483:web:2eacab83fb89a67812ff46",
  measurementId: "G-M5T6KE9YSE"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
let currentUser = null;
let selectedCategory = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';

auth.onAuthStateChanged(user=>{
  if(!user) window.location.href="login.html";
  currentUser = user;
  listenPosts();
});

document.getElementById('searchUser').addEventListener('keypress', e=>{
  if(e.key==='Enter') window.location.href='people.html?search='+document.getElementById('searchUser').value.trim();
});

function filterCategory(cat){
  selectedCategory = cat;
  listenPosts();
}

function listenPosts(){
  db.collection("posts").orderBy("timestamp","desc").onSnapshot(snapshot=>{
    const postsDiv = document.getElementById('posts');
    postsDiv.innerHTML="";
    snapshot.forEach(doc=>{
      const p = doc.data();
      // filter category
      if(selectedCategory!=='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' && p.category !== selectedCategory) return;

      const date = new Date(p.timestamp);
      const dateStr = date.toLocaleDateString('th-TH');

      const card = document.createElement('div');
      card.className="card";
      let deleteBtn = "";
      if(currentUser && currentUser.uid===p.user_id) deleteBtn = `<button onclick="deletePost('${doc.id}')">üóë ‡∏•‡∏ö</button>`;
      card.innerHTML = `
        <p><strong>@${p.username}</strong> - <em>${dateStr}</em></p>
        <p>${p.text}</p>
        <p style="color:#888;">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: ${p.category}</p>
        <div class="actions">
          <button onclick="likePost('${doc.id}')">‚ù§Ô∏è ${p.likes||0}</button>
          <button onclick="repostPost('${doc.id}')">üîÅ ${p.reposts||0}</button>
          ${deleteBtn}
        </div>
      `;
      postsDiv.appendChild(card);
    });
  });
}

function likePost(postId){
  const postRef = db.collection("posts").doc(postId);
  postRef.update({ likes: firebase.firestore.FieldValue.increment(1) });
}
function repostPost(postId){
  const postRef = db.collection("posts").doc(postId);
  postRef.update({ reposts: firebase.firestore.FieldValue.increment(1) });
}
function deletePost(postId){
  if(!currentUser) return;
  db.collection("posts").doc(postId).get().then(doc=>{
    if(doc.exists && doc.data().user_id===currentUser.uid){
      return db.collection("posts").doc(postId).delete();
    } else alert("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ");
  });
}
</script>
</body>
</html>
