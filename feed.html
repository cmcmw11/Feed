<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏ü‡∏µ‡∏î - ‡πÇ‡∏•‡∏Å‡∏™‡∏ß‡∏¢ Social</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap');
body { font-family: 'Quicksand', sans-serif; background:#f0f2f5; margin:0; padding:0; display:flex; justify-content:center; padding-top:30px; }
.container { width:400px; }
.card { background:#fff; border-radius:15px; padding:15px; margin-bottom:15px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
.card p { margin:5px 0; }
.card .actions { display:flex; justify-content:space-between; margin-top:10px; }
button { border:none; border-radius:10px; padding:5px 10px; cursor:pointer; }
button:hover { opacity:0.8; }
input, textarea { width:100%; padding:10px; margin:5px 0; border-radius:10px; border:1px solid #ddd; font-size:14px; }
#searchUser { margin-bottom:15px; padding:10px; border-radius:10px; border:1px solid #ddd; width:100%; }
</style>
</head>
<body>
<div class="container">
  <input type="text" id="searchUser" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô @username...">
  <div id="posts"></div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCXcq9coy4Ah39DTzN9OmZc-nm8JBHPapA",
  authDomain: "feed-32f94.firebaseapp.com",
  projectId: "feed-32f94",
  storageBucket: "feed-32f94.appspot.com",
  messagingSenderId: "939495314483",
  appId: "1:939495314483:web:2eacab83fb89a67812ff46",
  measurementId: "G-M5T6KE9YSE"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
let currentUser = null;

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
auth.onAuthStateChanged(user=>{
  if(!user) window.location.href="login.html";
  currentUser = user;
  listenPosts();
});

function listenPosts(){
  db.collection("posts").orderBy("timestamp","desc").onSnapshot(snapshot=>{
    const postsDiv = document.getElementById('posts');
    postsDiv.innerHTML="";
    snapshot.forEach(doc=>{
      const p = doc.data();
      // filter search
      const searchText = document.getElementById('searchUser').value.trim().toLowerCase();
      if(searchText && !p.username.toLowerCase().includes(searchText.replace("@",""))) return;

      const card = document.createElement('div');
      card.className = "card";
      let deleteBtn = "";
      if(currentUser && currentUser.uid === p.user_id) deleteBtn = `<button onclick="deletePost('${doc.id}')">üóë ‡∏•‡∏ö</button>`;
      
      let commentsHtml = "";
      if(p.comments) p.comments.forEach(c=>{
        commentsHtml += `<p><strong>@${c.username}:</strong> ${c.text}</p>`;
      });

      card.innerHTML = `
        <p><strong>@${p.username}</strong></p>
        <p>${p.text}</p>
        <p style="color:#888;">${(p.hashtags||[]).join(" ")}</p>
        <div class="actions">
          <button onclick="likePost('${doc.id}')">‚ù§Ô∏è ${p.likes||0}</button>
          <button onclick="repostPost('${doc.id}')">üîÅ ${p.reposts||0}</button>
          ${deleteBtn}
        </div>
        <div>
          ${commentsHtml}
          <input type="text" placeholder="‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô..." id="commentInput_${doc.id}">
          <button onclick="addComment('${doc.id}')">‡∏™‡πà‡∏á</button>
        </div>
      `;
      postsDiv.appendChild(card);
    });
  });
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏° Like
function likePost(postId){
  const postRef = db.collection("posts").doc(postId);
  postRef.update({ likes: firebase.firestore.FieldValue.increment(1) });
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏° Repost
function repostPost(postId){
  const postRef = db.collection("posts").doc(postId);
  postRef.update({ reposts: firebase.firestore.FieldValue.increment(1) });
}

// ‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå
function deletePost(postId){
  if(!currentUser) return;
  db.collection("posts").doc(postId).get().then(doc=>{
    if(doc.exists && doc.data().user_id === currentUser.uid){
      return db.collection("posts").doc(postId).delete();
    } else { alert("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ"); }
  });
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå
function addComment(postId){
  const input = document.getElementById('commentInput_'+postId);
  const text = input.value.trim();
  if(!text) return;
  db.collection("posts").doc(postId).update({
    comments: firebase.firestore.FieldValue.arrayUnion({
      user_id: currentUser.uid,
      username: currentUser.displayName||currentUser.email,
      text: text,
      timestamp: Date.now()
    })
  }).then(()=>{ input.value=""; });
}
</script>
</body>
</html>
