<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>WorldBright</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>
<style>
body{font-family:sans-serif;padding:20px;}
input,textarea,select,button{display:block;margin:5px 0;}
#feed{margin-top:20px;}
.post{border:1px solid #ccc;padding:10px;margin:10px 0;}
.repost-btn{margin-top:5px;cursor:pointer;color:blue;}
</style>
</head>
<body>

<h2>สมัครสมาชิก</h2>
<form id="registerForm">
  <input type="text" id="regUsername" placeholder="Username" required>
  <input type="password" id="regPassword" placeholder="Password" required>
  <select id="regGender">
    <option value="male">ชาย</option>
    <option value="female">หญิง</option>
    <option value="other">อื่นๆ</option>
  </select>
  <input type="date" id="regBirthdate" required>
  <button type="submit">สมัครสมาชิก</button>
</form>

<h2>เข้าสู่ระบบ</h2>
<form id="loginForm">
  <input type="text" id="loginUsername" placeholder="Username" required>
  <input type="password" id="loginPassword" placeholder="Password" required>
  <button type="submit">Login</button>
</form>

<div id="feed" style="display:none;">
  <h2>Feed</h2>
  <form id="postForm">
    <textarea id="postText" placeholder="เขียนโพสต์..."></textarea>
    <input type="text" id="postHashtag" placeholder="#hashtag">
    <button type="submit">โพสต์</button>
  </form>
  <div id="posts"></div>
  <button id="logoutBtn">Logout</button>
</div>

<script>
// --- Register ---
document.getElementById('registerForm').addEventListener('submit', e=>{
  e.preventDefault();
  const username=document.getElementById('regUsername').value;
  const password=document.getElementById('regPassword').value;
  const gender=document.getElementById('regGender').value;
  const birthdate=document.getElementById('regBirthdate').value;

  auth.createUserWithEmailAndPassword(username+'@example.com', password)
    .then(userCredential=>{
      const user=userCredential.user;
      db.collection('users').doc(user.uid).set({username, gender, birthdate});
      alert('สมัครสมาชิกเรียบร้อย');
    })
    .catch(err=>alert(err.message));
});

// --- Login ---
document.getElementById('loginForm').addEventListener('submit', e=>{
  e.preventDefault();
  const username=document.getElementById('loginUsername').value;
  const password=document.getElementById('loginPassword').value;
  auth.signInWithEmailAndPassword(username+'@example.com', password)
    .then(userCredential=>{
      document.getElementById('feed').style.display='block';
      listenPosts(); // ใช้ realtime listener
    })
    .catch(err=>alert(err.message));
});

// --- Logout ---
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  auth.signOut();
  document.getElementById('feed').style.display='none';
});

// --- Post ---
document.getElementById('postForm').addEventListener('submit', e=>{
  e.preventDefault();
  const text=document.getElementById('postText').value;
  const hashtags=document.getElementById('postHashtag').value.split(' ').filter(h=>h);
  const user=auth.currentUser;
  if(!user) return;

  db.collection('posts').add({
    user_id:user.uid,
    text,
    hashtags,
    timestamp:Date.now(),
    seen_count:0,
    repost_count:0,
    repost_from:null
  });
  document.getElementById('postText').value='';
  document.getElementById('postHashtag').value='';
});

// --- Realtime Posts & Seen Count ---
function listenPosts(){
  db.collection('posts').orderBy('timestamp','desc')
    .onSnapshot(snapshot=>{
      const postsDiv=document.getElementById('posts');
      postsDiv.innerHTML='';
      snapshot.forEach(doc=>{
        const data=doc.data();
        const div=document.createElement('div');
        div.className='post';
        let repostText='';
        if(data.repost_from) repostText=`<small>รีโพสต์จาก ${data.repost_from}</small><br>`;
        div.innerHTML=`<b>${data.user_id}</b>${repostText}<p>${data.text}</p><p>${data.hashtags.join(' ')}</p>
          <small>ผู้เห็น: <span id="seen-${doc.id}">${data.seen_count}</span> | รีโพสต์: ${data.repost_count}</small>
          <div class="repost-btn" onclick="repost('${doc.id}','${data.text}')">รีโพสต์</div>`;
        postsDiv.appendChild(div);

        // อัปเดต seen_count แบบ realtime
        const seenRef=db.collection('posts').doc(doc.id);
        seenRef.update({seen_count:data.seen_count+1});
      });
    });
}

// --- Repost ---
function repost(postId,text){
  const user=auth.currentUser;
  if(!user) return;
  const postRef=db.collection('posts').doc(postId);
  postRef.update({repost_count:firebase.firestore.FieldValue.increment(1)});
  db.collection('posts').add({
    user_id:user.uid,
    text,
    hashtags:[], // รีโพสต์ ไม่มีแฮชแท็กเดิมก็ได้
    timestamp:Date.now(),
    seen_count:0,
    repost_count:0,
    repost_from:postId
  });
}
</script>

</body>
</html>
